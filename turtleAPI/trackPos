---@diagnostic disable: undefined-global
-- TrackPos: simple movement tracking helper for CC:Tweaked turtles.
-- Load with `os.loadAPI("/path/trackPos")` then call `trackPos.moveForward(3)` etc.

local trackPos = {}

trackPos.position = { x = 0, y = 0, z = 0, d = 0 } -- d: 0=+Z,1=+X,2=-Z,3=-X

local function normalize(quantity)
  quantity = tonumber(quantity) or 1
  if quantity < 1 then
    return 1
  end
  return math.floor(quantity)
end

function trackPos.turnRight(quantity)
  quantity = normalize(quantity)
  for _ = 1, quantity do
    if turtle.turnRight() then
      trackPos.position.d = (trackPos.position.d + 1) % 4
    end
  end
end

function trackPos.turnLeft(quantity)
  quantity = normalize(quantity)
  for _ = 1, quantity do
    if turtle.turnLeft() then
      trackPos.position.d = (trackPos.position.d - 1) % 4
    end
  end
end

function trackPos.moveForward(quantity)
  quantity = normalize(quantity)
  for _ = 1, quantity do
    if turtle.forward() then
      if trackPos.position.d == 0 then
        trackPos.position.z = trackPos.position.z + 1
      elseif trackPos.position.d == 1 then
        trackPos.position.x = trackPos.position.x + 1
      elseif trackPos.position.d == 2 then
        trackPos.position.z = trackPos.position.z - 1
      elseif trackPos.position.d == 3 then
        trackPos.position.x = trackPos.position.x - 1
      end
    else
      return false
    end
  end
end

function trackPos.moveBackward(quantity)
  quantity = normalize(quantity)
  for _ = 1, quantity do
    if turtle.back() then
      if trackPos.position.d == 0 then
        trackPos.position.z = trackPos.position.z - 1
      elseif trackPos.position.d == 1 then
        trackPos.position.x = trackPos.position.x - 1
      elseif trackPos.position.d == 2 then
        trackPos.position.z = trackPos.position.z + 1
      elseif trackPos.position.d == 3 then
        trackPos.position.x = trackPos.position.x + 1
      end
    end
  end
end

function trackPos.moveUp(quantity)
  quantity = normalize(quantity)
  for _ = 1, quantity do
    if turtle.up() then
      trackPos.position.y = trackPos.position.y + 1
    end
  end
end

function trackPos.moveDown(quantity)
  quantity = normalize(quantity)
  for _ = 1, quantity do
    if turtle.down() then
      trackPos.position.y = trackPos.position.y - 1
    end
  end
end

function trackPos.getLocation()
  local x = trackPos.position.x
  local y = trackPos.position.y
  local z = trackPos.position.z
  local d = trackPos.position.d
  print("x="..x.." y="..y.." z="..z.." d="..d)
end

function trackPos.orient(target)
  -- normalize inputs to [0,3]
  local current = trackPos.position.d % 4
  local desired = (tonumber(target) or 0) % 4

  local delta = (desired - current) % 4
  if delta == 0 then
    return true
  elseif delta == 1 then
    trackPos.turnRight(1)
    return true
  elseif delta == 2 then
    trackPos.turnRight(2)
    return true
  else -- delta == 3
    trackPos.turnLeft(1)
    return true
  end
end

function trackPos.home()
  while trackPos.position.x ~= 0 or trackPos.position.y ~= 0 or trackPos.position.z ~= 0 do
    local x = trackPos.position.x
    local y = trackPos.position.y
    local z = trackPos.position.z
    local d = trackPos.position.d
    if y > 0 then
      trackPos.moveDown(y)
    elseif y < 0 then
      trackPos.moveUp(math.abs(y))
    end
    if x > 0 then
      trackPos.orient(3)
      trackPos.moveForward(x)
    elseif x < 0 then
      trackPos.orient(1)
      trackPos.moveForward(math.abs(x))
    end
    if z > 0 then
      trackPos.orient(2)
      trackPos.moveForward(z)
    elseif z < 0 then
      trackPos.orient(0)
      trackPos.moveForward(math.abs(z))
    end
    trackPos.orient()
  end
end

function trackPos.moveTo(target)
  target = target or {}
  local tx = target.x or 0
  local ty = target.y or 0
  local tz = target.z or 0
  local td = target.d

  local yDiff = trackPos.position.y - ty
  if yDiff > 0 then
    trackPos.moveDown(yDiff)
  elseif yDiff < 0 then
    trackPos.moveUp(math.abs(yDiff))
  end

  local xDiff = trackPos.position.x - tx
  if xDiff > 0 then
    trackPos.orient(3)
    trackPos.moveForward(xDiff)
  elseif xDiff < 0 then
    trackPos.orient(1)
    trackPos.moveForward(math.abs(xDiff))
  end

  local zDiff = trackPos.position.z - tz
  if zDiff > 0 then
    trackPos.orient(2)
    trackPos.moveForward(zDiff)
  elseif zDiff < 0 then
    trackPos.orient(0)
    trackPos.moveForward(math.abs(zDiff))
  end

  if td ~= nil then
    trackPos.orient(td)
  end
end

return trackPos
